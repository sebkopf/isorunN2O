## N2O Data Viewer

The N2O Data Viewer is a browser based Isodat run monitoring system that is part of the [isorunN2O](https://github.com/sebkopf/isorunN2O) data processing package and  built using the [Shiny](http://shiny.rstudio.com/) web application framework and the [Isoread](https://github.com/sebkopf/isoread#isoread) IRMS data interface R module. As a browser based application it is very easy to run on almost any system without the need for other types of graphical user interfaces and can automatically be hosted on an instrument machine for easy network access by users on the same network. It was specifically designed for instrument performance monitoring and on-the-fly data monitoring of big batch N2O isotope ratio measurements in the [Sigman lab](http://www.princeton.edu/sigman/) at Princeton, but could easily be adapted for similar analyses (e.g. traditional big batch EA-IRMS or gasbench-IRMS runs). For a few screenshot examples, take a look at the [linearity evaluation](#linearity-evaluation) and [real time data evaluation](#real-time-data-evaluation) below.

#### Running from R

To run the N2O data viewer, simply [install the isorunN2O package](https://github.com/sebkopf/isorunN2O#installation) and then run the following two lines. By default, the data browser starts in your current working directory, but you can specify which folder to use as the data directory by providing the `base_dir` parameter. For additional information, please consult the help (`?run_data_viewer` from the R comand line). The data viewer stores settings for each data directory in a `settings.csv` file that can be copied manually to new data directories if so desired.

```coffee
library(isorunN2O)
run_data_viewer()
```

#### Running as script

Alternatively, the N2O data viewer can be launched via `Rscript` directly (e.g. configured as a desktop link, or from the command line) using the following commands (pass in the `base_dir` parameter if you want a different data directory than where the script is stored).

```coffee
# unix/mac os (assuming Rscript is in your path)
Rscript -e "library(isorunN2O); run_data_viewer(launch.browser = TRUE)"
# windows
"C:\path\to\R\R-3.2.4\bin\Rscript.exe" -e "library(isorunN2O); run_data_viewer(launch.browser = TRUE)"
```

Examples for scripts that use this approach and that you can just copy into any directory (e.g. your data directory) and then launch the N2O data viewer from that directory are provided by [run.sh](https://github.com/sebkopf/isorunN2O/blob/master/inst/shiny-apps/data_viewer/run.sh) (for unix/mac, make sure `Rscript` is in your path and the script is executable `chmod +x run.sh`) and [run.bat](https://github.com/sebkopf/isorunN2O/blob/master/inst/shiny-apps/data_viewer/run.bat) (windows, make sure the path is current and points to your R installation).

#### Offline installation

Although installation is vastly more convenient with an internet connection, sometimes the mass spec computer where this tool would be most useful is not connected to the network. In this case, offline installation is possible and addressed in detail in the [troubleshooting](#troubleshooting) section below.

## Screenshots

#### Linearity evaluation

Linearity evaluation (loaded directly from raw Isodat file) and recording for historical evaluation.

![Screenshot of the Linearity File Selection](https://github.com/sebkopf/isorunN2O/blob/master/inst/shiny-apps/data_viewer/doc/linearity_selection.png?raw=true)
![Screenshot of the Linearity Evaluation](https://github.com/sebkopf/isorunN2O/blob/master/inst/shiny-apps/data_viewer/doc/linearity_evaluation.png?raw=true)
![Screenshot of the Linearity History](https://github.com/sebkopf/isorunN2O/blob/master/inst/shiny-apps/data_viewer/doc/linearity_history.png?raw=true)

#### Real time data evaluation

Data is processed as the files are generated by the instrument and can be plotted on the fly. Drift correction can also be evaluated based on different correction models.

![Screenshot of the Data Selection](https://github.com/sebkopf/isorunN2O/blob/master/inst/shiny-apps/data_viewer/doc/data_selection.png?raw=true)
![Screenshot of the Data Overview](https://github.com/sebkopf/isorunN2O/blob/master/inst/shiny-apps/data_viewer/doc/data_overview.png?raw=true)


## Troubleshooting

#### Installing on a system not connected to the internet

Download all the packages that are necessary. The easiest way to make this possible is by just pulling all current release packages from CRAN and transferring them to the offline system (warnings, these are a lot of files, >3.5 Gb total, and may take a long time to download). The CRAN directory depends on the operating system, R version (must match!) and source vs. binaries. For example, for R 3.2.x for the windows binaries, run in terminal:

```coffee
mkdir CRAN_packages
cd CRAN_packages
wget -nc ftp://cran.r-project.org/pub/R/bin/windows/contrib/3.2/*.zip
```

As well as the packages hosted on GitHub (run in terminal within CRAN_packages folder), which need to be converted to tar balls for installation (zip files don't work with ```install.packages```):
```coffee
mkdir GitHub_packages
cd GitHub_packages
curl -L -o tmp.zip https://github.com/ropensci/plotly/archive/master.zip && unzip tmp.zip && rm tmp.zip
curl -L -o tmp.zip https://github.com/sebkopf/isotopia/archive/master.zip && unzip tmp.zip && rm tmp.zip
curl -L -o tmp.zip https://github.com/sebkopf/isoread/archive/master.zip && unzip tmp.zip && rm tmp.zip
curl -L -o tmp.zip https://github.com/sebkopf/isorunN2O/archive/master.zip && unzip tmp.zip && rm tmp.zip
```

Transfer all these files to the offline system, specify the `source_path`, then generate a package dependency tree (platform dependent), and install the GitHub packages from the sources files.

**Dependency tree:**

```coffee
source_path <- "C:/path/to/CRAN_packages" # windows
#source_path <- "/path/to/CRAN_packages" # unix
library(tools)
write_PACKAGES(source_path, type = "win.binary")
#write_PACKAGES(source_path, type = "mac.binary")
```

**Installation**:

```coffee
# local repository
url <- paste0("file:", source_path) # windows
#url <- paste0("file:\\", source_path) # unix

# install devtools
install.packages("devtools", contriburl = url)

# install github packages with their dependencies
sapply(c("plotly", "isotopia", "isoread", "isorunN2O"), function(i) {
  pkg_path <- file.path(source_path, "GitHub_packages", paste0(i, "-master"))
  stopifnot(file.exists(pkg_path))
  deps <- devtools::dev_package_deps(pkg_path, dep = T)$package
  install.packages(deps, contriburl = url)
  tryCatch(devtools::install(pkg_path), error = function(e) message("NOTE: ", e$message))
  return("")
})
```

Note that sometimes Rgui.exe on windows will throw an error along the lines of *"The procedure entry point ... could not be located in the dynamic library ..."* when trying to load the newly installed packages during installation. This can be safely ignored and packages that otherwise installed without trouble should load okay when loading them with `library()`.
